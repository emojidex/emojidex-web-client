/**
 * cross-storage - Cross domain local storage
 *
 * @version   1.1.0
 * @link      https://github.com/zendesk/cross-storage
 * @author    Daniel St. Jules <danielst.jules@gmail.com>
 * @copyright Zendesk
 * @license   Apache-2.0
 */

!function(e){var r={};r.init=function(e,n){var t=localforage.supports(localforage.INDEXEDDB)||localforage.supports(localforage.WEBSQL)||localforage.supports(localforage.LOCALSTORAGE);return t?(n&&localforage.config(n),r._permissions=e||[],r._installListener(),window.parent.postMessage("cross-storage:ready","*"),void 0):window.parent.postMessage("cross-storage:unavailable","*")},r._installListener=function(){var e=r._listener;window.addEventListener?window.addEventListener("message",e,!1):window.attachEvent("onmessage",e)},r._listener=function(e){var n,t,o,a,i,s;if(n="null"===e.origin?"file://":e.origin,"cross-storage:poll"===e.data)return window.parent.postMessage("cross-storage:ready",e.origin);if("cross-storage:ready"!==e.data){try{o=JSON.parse(e.data)}catch(l){return}o&&"string"==typeof o.method&&(a=o.method.split("cross-storage:")[1],a&&(r._permitted(n,a)?r["_"+a](o.params).then(function(e){s=JSON.stringify({id:o.id,result:e}),t="file://"===n?"*":n,window.parent.postMessage(s,t)}).catch(function(e){s=JSON.stringify({id:o.id,error:e}),t="file://"===n?"*":n,window.parent.postMessage(s,t)}):i="Invalid permissions for "+a))}},r._permitted=function(e,n){var t,o,a,i;if(t=["get","set","del","clear","getKeys"],!r._inArray(n,t))return!1;for(o=0;o<r._permissions.length;o++)if(a=r._permissions[o],a.origin instanceof RegExp&&a.allow instanceof Array&&(i=a.origin.test(e),i&&r._inArray(n,a.allow)))return!0;return!1},r._set=function(e){return localforage.setItem(e.key,e.value)},r._get=function(e){return localforage.getItem(e.key)},r._del=function(e){return localforage.removeItem(e.key)},r._clear=function(){return localforage.clear()},r._getKeys=function(){var e,r;return r=[],localforage.length().then(function(n){for(e=0;n>e;e++)localforage.key(e,function(e){r.push(e)})}).then(function(){return r}).catch(function(e){console.log(e)})},r._inArray=function(e,r){for(var n=0;n<r.length;n++)if(e===r[n])return!0;return!1},r._now=function(){return"function"==typeof Date.now?Date.now():(new Date).getTime()},"undefined"!=typeof module&&module.exports?module.exports=r:"undefined"!=typeof exports?exports.CrossStorageHub=r:"function"==typeof define&&define.amd?define([],function(){return r}):e.CrossStorageHub=r}(this);