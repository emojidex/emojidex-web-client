/*
 *  emojidex client - v0.1.0
 *  * Provides search, index caching and combining and asset URI resolution
 *  https://github.com/emojidex/emojidex-web-client
 *
 *  =LICENSE=
 *  Licensed under the emojidex Open License
 *  https://www.emojidex.com/emojidex/emojidex_open_license
 *
 *  Copyright 2013 Genshin Souzou Kabushiki Kaisha
 */
(function(){var a;this.EmojidexClient=function(){function a(a){null==a&&(a={}),this._init_base_opts(a),this._auto_login(),this.next=function(){return null}}return a.prototype._init_base_opts=function(a){return this.defaults={locale:"en",api_url:"https://www.emojidex.com/api/v1/",cdn_url:"http://cdn.emojidex.com/emoji",closed_net:!1,min_query_len:4,size_code:"px32",detailed:!1,limit:32},a=$.extend({},this.defaults,a),this.closed_net=a.closed_net,this.api_url=a.api_url,this.cdn_url=a.cdn_url,this.size_code=a.size_code,this.detailed=a.detailed,this.limit=a.limit,this._init_storages(a),this.results=a.results||[],this.cur_page=a.page||1,this.cur_limit=this.limit,this.count=a.count||0},a.prototype._init_storages=function(a){return this.storage=$.localStorage,this.storage.isSet("emojidex")||this.storage.set("emojidex",{}),this.storage.isSet("emojidex.emoji")||this.storage.set("emojidex.emoji",a.emoji||[]),this.emoji=this.storage.get("emojidex.emoji"),this.storage.isSet("emojidex.history")||this.storage.set("emojidex.history",a.history||[]),this.history=this.storage.get("emojidex.history"),this.storage.isSet("emojidex.favorites")||this.storage.set("emojidex.favorites",a.favorites||[]),this.favorites=this.storage.get("emojidex.favorites"),this.storage.isSet("emojidex.categories")||this.storage.set("emojidex.categories",a.categories||[]),this.categories=this.storage.get("emojidex.categories"),this._pre_cache(a)},a.prototype._pre_cache=function(a){if(0===this.emoji.length)switch(a.locale){case"en":this.user_emoji("emoji"),this.user_emoji("emojidex");break;case"ja":this.user_emoji("絵文字"),this.user_emoji("絵文字デックス")}return 0===this.categories.length?this.get_categories(null,{locale:a.locale}):void 0},a.prototype._auto_login=function(){return this.closed_net?void 0:null!=this.storage.get("emojidex.auth_token")?(this.auth_status=this.storage.get("emojidex.auth_status"),this.auth_token=this.storage.get("emojidex.auth_token"),this.user=this.storage.get("emojidex.user"),this.get_user_data()):this.logout()},a.prototype.search=function(a,b,c){var d=this;return null==b&&(b=null),this.next=function(){return this.search(a,b,$.extend(c,{page:c.page+1}))},c=this._combine_opts(c),a.length>=this.defaults.min_query_len&&!this.closed_net?$.getJSON(this.api_url+"search/emoji?"+$.param($.extend({},{code_cont:this._escape_term(a)},c))).error(function(){return d.results=[]}).success(function(a){return d._succeed(a,b)}):this.local_search(a,b),this.local_search(a)},a.prototype.local_search=function(a,b){var c,d;return null==b&&(b=null),d=function(){var b,d,e,f;for(e=this.emoji,f=[],b=0,d=e.length;d>b;b++)c=e[b],this.emoji.code.match(".*"+a+".*/i")&&f.push(c);return f}.call(this),b?b(d):void 0},a.prototype.search_sw=function(a,b,c){var d=this;return null==b&&(b=null),this.next=function(){return this.search_sw(a,b,$.extend(c,{page:c.page+1}))},c=this._combine_opts(c),$.getJSON(this.api_url+"search/emoji?"+$.param($.extend({},{code_sw:this._escape_term(a)},c))).error(function(){return d.results=[]}).success(function(a){return d._succeed(a,b)})},a.prototype.search_ew=function(a,b,c){var d=this;return null==b&&(b=null),this.next=function(){return this.search_ew(a,b,$.extend(c,{page:c.page+1}))},c=this._combine_opts(c),$.getJSON(this.api_url+"search/emoji?"+$.param($.extend({},{code_ew:this._escape_term(a)},c))).error(function(){return d.results=[]}).success(function(a){return d._succeed(a,b)})},a.prototype.tag_search=function(a,b,c){var d=this;return null==b&&(b=null),this.next=function(){return this.tag_search(term,b,$.extend(c,{page:c.page+1}))},c=this._combine_opts(c),$.getJSON(this.api_url+"search/emoji?"+$.param($.extend({},{"tags[]":this._breakout(a)},c))).error(function(){return d.results=[]}).success(function(a){return d._succeed(a,b)})},a.prototype.advanced_search=function(a,b,c,d,e){var f,g=this;return null==b&&(b=[]),null==c&&(c=[]),null==d&&(d=null),this.next=function(){return this.advanced_search(a,b,c,d,$.extend(e,{page:e.page+1}))},e=this._combine_opts(e),f={code_cont:this._escape_term(a)},b.length>0&&(f=$.extend(f,{"tags[]":this._breakout(b)})),c.length>0&&(f=$.extend(f,{"categories[]":this._breakout(c)})),$.getJSON(this.api_url+"search/emoji?"+$.param($.extend(f,e))).error(function(){return g.results=[]}).success(function(a){return g._succeed(a,d)})},a.prototype.user_emoji=function(a,b,c){var d=this;return null==b&&(b=null),c=this._combine_opts(c),$.getJSON(this.api_url+"users/"+a+"/emoji?"+$.param(c)).error(function(){return d.results=[]}).success(function(a){return d._succeed(a,b)})},a.prototype.get_index=function(a,b){var c=this;return null==a&&(a=null),this.next=function(){return this.get_index(a,$.extend(b,{page:b.page+1}))},b=this._combine_opts(b),$.getJSON(this.api_url+"/emoji?"+$.param(b)).error(function(){return c.results=[]}).success(function(b){return c._succeed(b,a)})},a.prototype.get_newest=function(a,b){var c=this;return null==a&&(a=null),this.next=function(){return this.get_newest(a,$.extend(b,{page:b.page+1}))},b=this._combine_opts(b),$.getJSON(this.api_url+"/newest?"+$.param(b)).error(function(){return c.results=[]}).success(function(b){return c._succeed(b,a)})},a.prototype.get_popular=function(a,b){var c=this;return null==a&&(a=null),this.next=function(){return this.get_popular(a,$.extend(b,{page:b.page+1}))},b=this._combine_opts(b),$.getJSON(this.api_url+"/popular?"+$.param(b)).error(function(){return c.results=[]}).success(function(b){return c._succeed(b,a)})},a.prototype.get_categories=function(a,b){var c=this;return null==a&&(a=null),b=this._combine_opts(b),$.getJSON(this.api_url+"categories?"+$.param(b)).error(function(){return c.categories=[],c.storage.set("emojidex.categories",c.categories)}).success(function(b){return c.categories=b.categories,c.storage.set("emojidex.categories",c.categories),a?a(b.categories):void 0})},a.prototype.login=function(a){switch(a.authtype){case"plain":return this.plain_auth(a.username,a.password,a.callback);case"basic":return this.basic_auth(a.user,a.pass,a.callback);case"google":return this.google_auth(a.callback);default:return this._auto_login()}},a.prototype.logout=function(){return this.auth_status="none",this.storage.set("emojidex.auth_status",this.auth_status),this.user="",this.storage.set("emojidex.user",this.user),this.auth_token=null,this.storage.set("emojidex.auth_token",this.auth_token)},a.prototype.plain_auth=function(a,b,c){var d,e=this;return null==c&&(c=null),d=this.api_url+"users/authenticate?"+$.param({username:a,password:b}),$.getJSON(d).error(function(a){return e.auth_status=a.auth_status,e.auth_token=null,e.user=""}).success(function(a){return e._set_auth_from_response(a),c?c(a.auth_token):void 0})},a.prototype.basic_auth=function(a,b,c){return null==c&&(c=null),!1},a.prototype.google_auth=function(a){return null==a&&(a=null),!1},a.prototype._set_auth_from_response=function(a){return this.auth_status=a.auth_status,this.storage.set("emojidex.auth_status",this.auth_status),this.auth_token=a.auth_token,this.storage.set("emojidex.auth_token",this.auth_token),this.user=a.auth_user,this.storage.set("emojidex.user",this.user),this.get_user_data()},a.prototype.get_user_data=function(){return this.get_favorites(),this.get_history()},a.prototype.get_history=function(){var a=this;return null!=this.auth_token?$.getJSON(this.api_url+"users/history?"+$.param({auth_token:this.auth_token})).error(function(){return a.history=[]}).success(function(b){return a.history=b}):void 0},a.prototype.set_history=function(a){return null!=this.auth_token?$.post(this.api_url+"users/history?"+$.param({auth_token:this.auth_token,emoji_code:a})):void 0},a.prototype.get_favorites=function(a){var b=this;return null!=this.auth_token?$.ajax({url:this.api_url+"users/favorites",data:{auth_token:this.auth_token},success:function(c){return b.favorites=c,null!=a?a(b.favorites):void 0},error:function(){return b.favorites=[]}}):void 0},a.prototype.set_favorites=function(a,b){var c=this;return null!=this.auth_token?$.ajax({type:"POST",url:this.api_url+"users/favorites",data:{auth_token:this.auth_token,emoji_code:a},success:function(){return c.get_favorites(),null!=b?b(c.favorites):void 0}}):void 0},a.prototype.unset_favorites=function(a){return null!=this.auth_token?$.ajax({type:"DELETE",url:this.api_url+"users/favorites",data:{auth_token:this.auth_token,emoji_code:a},success:function(){}}):void 0},a.prototype.combine_emoji=function(a){return $.extend(this.emoji,a)},a.prototype.simplify=function(a,b){var c,d,e,f;for(null==a&&(a=this.results),null==b&&(b=this.size_code),f=[],d=0,e=a.length;e>d;d++)c=a[d],f.push({code:this._escape_term(c.code),img_url:""+this.cdn_url+"/"+b+"/"+this._escape_term(c.code)+".png"});return f},a.prototype._combine_opts=function(a){return $.extend({},{page:1,limit:this.limit,detailed:this.detailed},a)},a.prototype._succeed=function(a,b){return this.results=a.emoji,this.cur_page=a.meta.page,this.count=a.meta.count,this.combine_emoji(a.emoji),b?b(a.emoji):void 0},a.prototype._breakout=function(a){return null===a?[]:(a instanceof Array||(a=[a]),a)},a.prototype._escape_term=function(a){return a.split(" ").join("_")},a.prototype._de_escape_term=function(a){return a.split("_").join(" ")},a}(),a=function(){function a(){console.log("Test Class")}return a.prototype.log=function(a){return console.log(a)},a}()}).call(this);